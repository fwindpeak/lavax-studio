# LavStudio 已知问题追踪

> 所有问题按优先级排序，修复后标记为 ✅ 并注明修复版本

---

## 🔴 P0 - 阻塞性问题（导致崩溃或无法使用）

### VM-001: 栈下溢无保护
- **状态**: ⚠️ 待修复（已回退）
- **模块**: VM (`src/vm.ts`)
- **现象**: 程序莫名其妙退出，无错误信息
- **原因**: `pop()` 在栈空时返回 `lastValue` 而不是抛出错误
- **潜在风险**: 直接抛出错误可能破坏正常程序运行，需要更仔细的分析
- **建议**: 先验证其他问题，VM 修复放在最后
- **测试验证**: 运行 `tests/repro_underflow.ts`

---

### GFX-001: 绘图缓冲区规则（待验证）
- **状态**: ⚠️ 待验证
- **模块**: GraphicsEngine, SyscallHandler
- **当前实现**: 
  - `Point`, `Line`, `Box`, `Circle`, `Ellipse`, `GetBlock`: 使用 "Rule A"（bit 6=1 → GBUF）
  - `TextOut`, `WriteBlock`, `FillArea`: 使用 "Rule B"（bit 6=1 → VRAM），已做翻转处理
- **问题**: 文档说明和实现是否完全匹配需要测试验证
- **测试方法**: 运行 `tests/verify_graphics_rules.ts` 检查各函数行为
- **如果发现问题**: 需要检查具体哪个函数的 mode 处理不正确

---

## 🟡 P1 - 高优先级（影响功能完整性）

### DC-001: 反编译器改进
- **状态**: ⚠️ 部分修复 (2026-02-14)
- **模块**: Decompiler (`src/decompiler.ts`)
- **已改进**:
  - ✅ 变量信息收集（从内存访问模式推断类型）
  - ✅ 识别数组访问 (LD_G_O, LD_L_O)
  - ✅ 处理 INIT 指令（生成数组初始化注释）
  - ✅ 识别函数边界 (FUNC/RET)
  - ✅ 改进指令处理（更多算术/逻辑指令）
  - ✅ 系统调用参数处理
- **待完善**:
  - 控制流分析（if/else/while/for 结构恢复）
  - 完整的数组值提取和格式化
  - 变量类型精确推断
  - 生成可重新编译的 C 代码

---

### CMP-001: 生成的 LAV 在正式 VM 上无法运行
- **状态**: ❌ 待调查
- **模块**: Compiler, Assembler
- **现象**: 编译生成的 .lav 文件在文曲星真机或官方模拟器上无法运行
- **可能原因**:
  - [ ] 文件头格式差异
  - [ ] 字节序问题
  - [ ] 某些指令实现差异
  - [ ] 内存布局不同
- **调查步骤**:
  1. 对比原始文曲星文件的 hex dump
  2. 检查入口地址计算
  3. 验证指令编码
- **测试文件**: `examples/boshi.c`（博士失踪记游戏）

---

### VM-002: 栈溢出检查不完整
- **状态**: ❌ 未修复
- **模块**: VM (`src/vm.ts`)
- **现象**: 递归太深时可能破坏内存
- **代码位置**: `push()` 方法
- **修复方案**: 添加栈上限检查

---

## 🟢 P2 - 中优先级（影响体验）

### CMP-002: 结构体支持不完善
- **状态**: ❌ 未修复
- **模块**: Compiler
- **现象**: struct 定义和访问有问题
- **当前状态**: 基本未实现

---

### CMP-003: 浮点数字面量处理不完整
- **状态**: ❌ 未修复
- **模块**: Compiler
- **现象**: 编译时浮点数处理不正确

---

### CMP-004: 复杂表达式解析错误
- **状态**: ❌ 未修复
- **模块**: Compiler
- **现象**: 某些复杂嵌套表达式解析失败

---

### GFX-002: 中文字体渲染问题
- **状态**: ⚠️ 部分修复
- **模块**: GraphicsEngine
- **现象**: 中文显示可能有乱码或位置偏移
- **依赖**: 需要 `fonts.dat` 文件

---

### VM-003: 浮点运算精度差异
- **状态**: ⚠️ 已知
- **模块**: VM
- **现象**: 与原生 LavaX 浮点行为可能有差异
- **原因**: JavaScript 浮点数 vs 原生实现

---

## ✅ 已修复问题

### ~~VM-101: main 函数入口点错误~~
- **状态**: ✅ 已修复 (2026-02-11)
- **修复内容**: 
  - 之前: `CALL main` + `RET`，导致 main 返回到无效地址
  - 现在: `JMP main` + `EXIT`，main 直接作为程序入口

### ~~VM-102: 栈帧计算错误~~
- **状态**: ✅ 已修复 (2026-02-11)
- **修复内容**:
  - 之前: `frameSize = localVarsSize + 5`，未考虑参数空间
  - 现在: `frameSize = 5 + (params.length * 4) + localVarsSize`

### ~~ASM-101: 标签格式错误~~
- **状态**: ✅ 已修复 (2026-02-11)
- **修复内容**:
  - 之前: 标签有尾随空格（如 `L_ELSE_0 : `）
  - 现在: 正确格式（如 `L_ELSE_0:`）

---

## 🎯 修复优先级建议

### 第一阶段：稳定性（立即）
1. VM-001: 栈下溢保护
2. GFX-001: 绘图缓冲区规则

### 第二阶段：功能完整性（本周）
3. DC-001: 反编译器重写
4. CMP-001: LAV 兼容性调查

### 第三阶段：完善（后续）
5. VM-002: 栈溢出保护
6. CMP-002: 结构体支持
7. 其他编译器改进

---

## 🧪 回归测试清单

修复后需要验证的测试用例：
- [ ] `tests/simple_test.ts` - 基础功能
- [ ] `tests/verify_fix.ts` - 修复验证
- [ ] `tests/verify_graphics_rules.ts` - 绘图规则
- [ ] `tests/test_syscalls.ts` - 系统调用
- [ ] `examples/boshi.c` - 完整游戏
- [ ] 闭环测试：源码 → 编译 → 运行 → 反编译 → 编译 → 运行

---
*最后更新：2026-02-14*
